!function(e){var t={};function r(n){if(t[n])return t[n].exports;var s=t[n]={i:n,l:!1,exports:{}};return e[n].call(s.exports,s,s.exports,r),s.l=!0,s.exports}r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)r.d(n,s,function(t){return e[t]}.bind(null,s));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=7)}([function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.trim=(e=>{if(e&&(e=e.trim()).length)return e}),t.flow=(e=>({then:r=>e?t.flow(r(e)):t.flow(void 0),value:e}))},function(e,t){e.exports=require("path")},function(e,t){e.exports=require("chalk")},function(e,t){e.exports=require("jsdom")},function(e,t){e.exports=require("p-limit")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(0),s=r(3),o=r(1),i=r(23),a=n.flow(new s.JSDOM).then(e=>e.window.Node).value,c=e=>e.nodeType===a.ELEMENT_NODE;class l{constructor(){this.names=new Set,this.urls=new Map}resolveName(e){if("."===(e=o.normalize(n.trim(e)||"")))return;const t=o.extname(e),r=i(o.basename(e,t));e=r+t;const{names:s}=this;if(!s.has(e))return s.add(e),e;for(let e=1;e<100;e++){const n=`${r} (${e})${t}`;if(!s.has(n))return s.add(n),n}return""}mapURL(e,t){this.urls.set(e,t)}resolveURL(e){return this.urls.get(e)||e}parseNode(e){return this.render(l.tokenize(e))}render(e){let t="";for(const r of e){let e;switch(r.type){case"text":e=r.text;break;case"ruby":e=`${r.text}(${r.ruby})`;break;case"link":e=`[${r.text}](${this.resolveURL(r.url)})`;break;case"image":e=`![${r.text}](${this.resolveURL(r.url)})`;break;case"br":e="\n";break;default:e=""}t+=e}return t}static tokenizeArray(e){return[...e].reduce((e,t)=>e.concat(l.tokenize(t)),[])}static tokenize(e){if(e.nodeType===a.TEXT_NODE)return[{type:"text",text:(e.textContent||"").replace(/^\n|\n$/g,"")}];if(!c(e))return[];switch(e.nodeName){case"RUBY":{const t=n.trim(n.flow(e.querySelector("rb")).then(e=>e.textContent).value||n.flow([...e.children]).then(e=>{let t="";for(const r of e)r.nodeType===a.TEXT_NODE&&(t+=r.textContent);return t}).value||e.textContent);if(t){const r=n.flow(e.querySelector("rt")).then(e=>n.trim(e.textContent)).value;return r&&t!==r?[{type:"ruby",text:t,ruby:r}]:[{type:"text",text:t}]}return[]}case"BR":return n.flow(e.nextSibling).then(e=>e.nodeType===a.TEXT_NODE&&e.textContent||void 0).then(e=>e.startsWith("\n"))?[]:[{type:"br"}];case"A":{const t=e,r={type:"link",text:t.textContent||t.href,url:t.href},n=[...t.querySelectorAll("img")].reduce((e,t)=>e.concat(this.tokenize(t)),[]);return n.length?(n.push({type:"br"}),n.push(r),n):[r]}case"IMG":{const t=e;return[{type:"image",text:t.alt,url:t.src}]}case"IFRAME":case"VIDEO":case"EMBEDED":return[];case"P":{const t=l.tokenizeArray(e.childNodes);return t.push({type:"br"}),t}default:return l.tokenizeArray(e.childNodes)}}}t.Context=l;t.SimpleContext=class extends l{constructor(){super(...arguments),this.text=[],this.bufs=[]}requestFile(e,t){const r=this.resolveName(e);if(!r)return;let n=t(r);Array.isArray(n)?this.text.push([r,n]):this.bufs.push([r,n])}}},function(e,t){e.exports=require("fs")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(8),s=r(10),o=r(2);try{n.parser.command(s).help().fail((e,t)=>{n.parser.showHelp(),t?console.log(o.default.red(t.stack||"")):console.error(o.default.red(e))}).parse()}catch(e){console.error(o.default.red((e.stack||"").toString()))}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(9);t.parser=n.strict(!0).usage("$0 <cmd> [args]").demandCommand(1).group(["help","version"],"Info:").option("pedantic",{default:!0,hidden:!0,type:"boolean",desc:"Exit on first error"})},function(e,t){e.exports=require("yargs")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(1),s=r(2),o=r(11),i=r(12),a=n.resolve(".");t.handler=(async e=>{if(!e.sources)throw new Error("no sources specified");const t=!!e.checkFs,a=e.outputDir||n.resolve("download"),{Series:c}=await Promise.resolve().then(()=>r(13)),l=e.name||[],u=e.sources.map(t=>"url"===t.type?new c({overwrite:e.overwrite,outputDir:a,sourceURL:t.url.toString(),basename:l.shift()}):new c({overwrite:e.overwrite,outputDir:n.dirname(t.fpath),basename:n.basename(t.fpath)}));for(const e of u){const r=process.stdout.columns||40;let a;await e.ready;const c=await e.updateIndex({onProgress:(e,t,c)=>{if(a)a.tick();else{const t=Math.floor(r/2)-2*c.toString().length,l=i(`${n.basename(e.container.name||"unknown")}`,t);a=new o(s.default`{gray [{green :bar}] [:current/:total]} ${l}`,{complete:"█",incomplete:"░",width:Math.floor(r/3),clear:!0,total:c})}},checkFs:t});console.log(s.default`{gray [{yellow ${c.updates.length.toString()} updated}, {green ${c.news.length.toString()} new}]} ${n.basename(e.container.name||"unknown")}`);const l=c.news.length;for(const{index:e,chapter:t}of c.news.slice(0,20))console.log(s.default`{green ${e.toString().padStart(3,"0")}} ${t.name}`);c.news.length>20&&console.log(s.default`...and {green ${l.toString()}} more chapters`)}}),t.command="get [<sources>..]",t.describe="Download novel from sources",t.builder=(e=>e.strict().usage("$0 get [--output-dir=<path>] [options] [<URL> | <path>..]").coerce("sources",e=>(Array.isArray(e)||(e=[e]),e.map(e=>{try{return{type:"url",url:new URL(e)}}catch(t){return{type:"folder",fpath:n.relative(a,n.resolve(e))}}}))).option("output-dir",{type:"string",default:"download",requiresArg:!0,coerce:e=>{if(Array.isArray(e))throw new Error("--output-dir was used twice");return n.normalize(e)},desc:"Output directory"}).option("name",{type:"string",requiresArg:!0,coerce:e=>Array.isArray(e)?e:[e],desc:"Hint to name new folder"}).option("overwrite",{type:"boolean",default:!1,desc:"Force overwriting exist data"}).option("check-fs",{type:"boolean",default:!1,desc:"Download missing files"}))},function(e,t){e.exports=require("progress")},function(e,t){e.exports=require("cli-truncate")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r(14);t.Series=n.Series,t.SeriesOptions=n.SeriesOptions},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r(15);t.Series=n.Series,t.SeriesOptions=n.SeriesOptions},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(16),s=r(24),o=r(28),i=r(1);t.Series=class{constructor(e){const t=Object.assign({},e.novel,e.data);let r;this.data=t,this.novel=e.novel,this.overwrite=!!e.overwrite;const n=e.basename||this.data.name;t.name=n;const o=(r=e.basename?new s.Folder(null,i.join(e.outputDir,e.basename)):new s.Folder(null,e.outputDir).requestFolder(n||"")).requestFile("index.json");this.container=r,this.metaFile=o,this.ready=(async()=>{!this.novel&&e.sourceURL&&await this.loadURL(e.sourceURL),n&&await this.load()})()}async loadURL(e){try{const t=new URL(e);this.novel=await n.getNovel(t)}catch(e){throw new Error("failed to get novel")}}async verify(e){if(e&&"object"==typeof e){if(e.sourceURL){if(!this.overwrite)throw new Error("unsupported older version, use overwrite to refresh");if(!this.novel)try{const t=new URL(e.sourceURL);this.novel=await n.getNovel(t)}catch(e){throw new Error("failed to get novel")}}return e.id?e:void 0}}async load(){const{metaFile:e,data:t,data:{name:r}}=this;if(r)try{const r=await e.read(),n=JSON.parse(r.toString());Object.assign(t,await this.verify(n)),!this.novel&&t.url&&await this.loadURL(t.url)}catch(e){if("ENOENT"!==e.code)throw e}}hasMeta(){const{data:e}=this;return!!(e.name&&e.author&&e.description&&e.genre&&e.keywords&&e.status)}async update(){const{novel:e,data:t}=this;if(!e)throw new Error("novel is undefined");this.hasMeta()||await e.fetch(),Object.assign(t,e);const r=t.name;r&&this.container.renameable&&await this.container.rename(r),await this.metaFile.write(JSON.stringify(t,null,1))}async updateIndex(e={}){const{onProgress:t,checkFs:r=!1}=e;let n;t&&(n=t.bind(void 0,this)),await this.update(),this.episodes||(this.episodes=new o.EpisodeList(this.container));const{novel:s,episodes:i}=this;if(!s)throw new Error("novel is undefined");await i.ready;const a=await s.fetchIndex();return i.updateWith(a,{progress:n,checkFs:r})}}},function(e,t,r){"use strict";let n;Object.defineProperty(t,"__esModule",{value:!0});const s=new Map;t.register=(e=>{for(const t of e.acceptDomains){if(s.has(t))throw new Error(`'${t}' domain existed`);s.set(t,e)}}),t.getProvider=(async e=>{if(!n)return n=(async()=>{t.register((await Promise.resolve().then(()=>r(17))).default)})(),await n,t.getProvider(e);let o=s.get(e.host);if(!o)throw new Error("no matching provider");return o}),t.getNovel=(async e=>{let r=(await t.getProvider(e)).fromURL(e);if(!r)throw new Error("failed to create Novel instance");return r})},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(0),s=r(18),o=r(5);class i{constructor(e){this.url=e.url,this.group=e.group,this.name=e.name,this.updateId=e.updateId}async fetch(){const e=this.url.toString(),t=(await s.fetchDOM(e)).getElementById("novel_contents");if(!t)return;n.flow(t.querySelector(".novel_subtitle")).then(e=>n.trim(e.textContent)).then(e=>{this.name=e});const r=[];["#novel_p","#novel_honbun","#novel_a"].forEach(e=>n.flow(t.querySelector(e)).then(e=>{r.push(e)}));const i=r.map(o.Context.tokenize),a=[];for(const e of i)for(const t of e)"image"===t.type&&a.push(s.fetchFile(t.url));const c=await Promise.all(a);this.content=(e=>{for(const t of c)e.requestFile(t.name,r=>(e.mapURL(t.url,r),t.buf));e.requestFile(this.name+".txt",t=>{const r=i.map(t=>e.render(t));return r.unshift(this.name),r})})}}t.SyosetuChapter=i;class a{constructor(e){const t=e.hostname;if(0===t.indexOf("novel18."))this.over18=!0;else{if(0!==t.indexOf("ncode."))throw new Error("wrong domain");this.over18=!1}const r=e.pathname.split("/",2);if(r.length<2)throw new Error("invalid pathname");this.id=r[1],this.url=this.indexURL}get rootURL(){return`https://${this.over18?"novel18":"ncode"}.syosetu.com/`}get infoURL(){return`${this.rootURL}novelview/infotop/ncode/${this.id}/`}get indexURL(){return`${this.rootURL}${this.id}/`}async fetch(){const e=this.infoURL,t=await s.fetchDOM(e),r=t.getElementById("contents_main");if(!r)throw console.log(t.body.innerHTML),new Error("failed to find contents");{const e=r.getElementsByTagName("h1")[0];if(!e)throw new Error("failed to parse header");this.name=e.textContent||void 0}{const e=r.querySelectorAll("#noveltable1 > tbody > tr > td");if(4!==e.length)throw new Error("failed to parse table");this.description=n.trim(e[0].textContent),this.author=n.trim(e[1].textContent),this.keywords=n.flow(n.trim(e[2].textContent)).then(e=>e.split(/\s+/g)).value,this.genre=n.flow(n.trim(e[3].textContent)).then(e=>e.split("〔",1)[0]).value}{let e=!0,t=0,n=r.querySelector("#noveltype_notend");if(n?e=!1:n=r.querySelector("#noveltype"),!n||!n.textContent)throw new Error("failed to detect novel type");if("短編"===n.textContent.trim())t=1;else{let e=n.nextSibling;if(!e||!e.textContent)throw new Error("failed to detect novel size");let r=e.textContent.match(/(?<=全)\d+(?=部分)/);r&&r[0]&&(t=parseInt(r[0],10))}this.status={completed:e,size:t}}}async fetchIndex(){const e=this.indexURL;let t=(await s.fetchDOM(e)).getElementsByClassName("index_box")[0];if(!t)throw new Error("failed to get index_box");const r=[];let o;for(const e of t.children)if(e.classList.contains("chapter_title"))o=n.trim(e.textContent);else if(e.classList.contains("novel_sublist2")){if(e.children.length<2)continue;let t,s,a;{const r=e.children[0].firstElementChild;if(r&&"A"===r.tagName){let e=r;t=n.trim(r.textContent),s=new URL(e.href)}}{const t=e.children[1],r=t.firstElementChild;a=r?n.trim(r.getAttribute("title")):n.trim(t.textContent)}if(t&&s){let e=new i({url:s,group:o,name:t,updateId:a});r.push(e)}}return r}}t.SyosetuNovel=a;const c={acceptDomains:["ncode.syosetu.com","novel18.syosetu.com"],fromURL:e=>{try{return new a(e)}catch(e){return}}};t.default=c},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(0),s=r(3),o=r(19),i=r(20);t.fetchDOM=(async e=>{let{window:{document:t}}=new s.JSDOM(await(await i.default(e)).text(),{url:e});return t}),t.fetchFile=(async e=>{const t=await i.default(e),r=await t.buffer();{const s=t.headers.get("content-disposition");if(s){const t=n.trim(n.flow(s.match(/; filename="[^"]+"/)).then(e=>e[1]).value);if(t)return{url:e,buf:r,name:t}}}{const s=t.headers.get("content-type");if(s){const t=n.flow(n.trim(s.split(";")[0])).then(o.getExtension).value;if(t)return{url:e,buf:r,name:`untitled.${t}`}}}return{url:e,buf:r,name:"untitled"}})},function(e,t){e.exports=require("mime")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(21),s=r(22),o=r(4).default(1);t.default=function(e,t){let r="string"==typeof e?new URL(e.toString()):new URL(e.url);if(r.host.endsWith("syosetu.com")){t||(t={});const i=new s.Headers(t.headers);return t.headers=i,/^(novel18|noc|mnlt|mid)./.test(r.hostname)&&i.set("Cookie",n.serialize("over18","yes")),o(()=>s.default(e,t))}return s.default(e,t)}},function(e,t){e.exports=require("cookie")},function(e,t){e.exports=require("node-fetch")},function(e,t){e.exports=require("filenamify")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(0),s=r(25),o=r(1),i=r(27),a=e=>n.flow(n.trim(e)).then(o.normalize).then(e=>{if(o.basename(e)===e&&!e.startsWith(".."))return e}).value;class c{constructor(e,t){this.children=new Set,this._accessed=!1,e?(this.parent=e,this._dirname=a(t)):this._dirname=o.resolve(t)}get name(){return this._dirname}get path(){const{parent:e,_dirname:t}=this;if(!t)throw new Error("Folder's path is undefined");return e?o.join(e.path,t):t}async real(){this._accessed||(await i(this.path),this._accessed=!0)}async close(){delete this._dirname,this.parent&&this.parent.children.delete(this)}async remove(){const{children:e}=this;if(!e.size)throw new Error("folder is not empty");const t=this.path;await this.close(),await s.rmdir(t)}get renameable(){return!!this.parent}async rename(e){if(!this.parent)throw new Error("folder cannot be renamed");const t=a(e);if(!t)throw new Error("folder name is invalid");const r=this._dirname;if(this._dirname=t,this._accessed=!1,r){if(t===r)return;try{const e=this.parent.path;await s.rename(o.join(e,r),o.join(e,t))}catch(e){if("ENOENT"!==e.code)throw e}}}requestFolder(e){const t=new c(this,e);return this.children.add(t),t}requestFile(e){const t=new l(this,e);return this.children.add(t),t}}t.Folder=c;class l{constructor(e,t){this.parent=e,this._filename=a(t)}get path(){const{parent:e,_filename:t}=this;if(!t)throw new Error("filename is not set");return o.join(e.path,t)}async real(){if(!this._filename)throw new Error("filename is not set")}async rename(e){const t=a(e);if(!t)throw new Error("filename is invalid");const r=this._filename;if(this._filename=t,r){if(t===r)return;try{const e=this.parent.path;await s.rename(o.join(e,r),o.join(e,t))}catch(e){if("ENOENT"!==e.code)throw e}}}async close(){delete this._filename,this.parent.children.delete(this)}async access(e){return s.access(this.path,e)}async remove(){await this.real();const e=this.path;await this.close();try{await s.unlink(e)}catch(e){if("ENOENT"!==e.code)throw e}}async read(){return await this.real(),s.readFile(this.path)}async write(e){await this.parent.real(),await this.real(),await s.writeFile(this.path,e)}}t.File=l},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(6),s=r(26);var o=r(6);t.constants=o.constants,t.readFile=s.promisify(n.readFile),t.writeFile=s.promisify(n.writeFile),t.rename=s.promisify(n.rename),t.unlink=s.promisify(n.unlink),t.rmdir=s.promisify(n.rmdir),t.access=s.promisify(n.access)},function(e,t){e.exports=require("util")},function(e,t){e.exports=require("make-dir")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(0),s=r(5),o=r(29),i=r(4),a=r(30);class c extends s.Context{constructor(e){super(),this.files=new Map,this.prefix=e}requestFile(e,t){const{files:r,prefix:s}=this;n.flow(this.resolveName(`${s}${e}`.trim())).then(e=>{r.has(e)||r.set(e,t(e))})}}t.EpisodeList=class{constructor(e,t={}){this.pad0=3,this.saveThrottle=a(this.save.bind(this),3e3),this.rootDir=e,this.data=t.data||{groups:[],episodes:[]},this.compressedCache=!!t.compressedCache,this.pad0=t.pad0||this.pad0;const r=e.requestFolder("!meta").requestFile(this.compressedCache?"!cache.json.gz":"!cache.json"),n=[e.requestFolder("0".padStart(this.pad0,"0"))];this.folders=n,this.metaFile=r,this.ready=this.load()}async updateWith(e,t={}){const{data:{episodes:r}}=this,{groups:n,chapters:s}=this.preprocess(e),{progress:o}=t,a={updates:[],news:[]},c=i.default(2),l=r.length;await this.updateGroups(n);const u=[];for(const[e,r]of s.entries())if(await this.pingEpisode(e,r,t)){const t={index:e,chapter:r};u.push(t),e<l?a.updates.push(t):a.news.push(t)}let d=0;const h=u.length;return o&&o(0,h),await Promise.all(u.map(({index:e,chapter:r})=>c(async()=>{await this.updateEpisode(e,r,t),await this.saveThrottle(),o&&o(++d,h)}))),r.length=s.length,await this.saveThrottle.flush(),a}encode(e){return this.compressedCache?o.gzipSync(JSON.stringify(e)):JSON.stringify(e,null,1)}decode(e){return this.compressedCache?JSON.parse(o.gunzipSync(e).toString()):JSON.parse(e.toString())}async updateGroups(e){const{folders:t,rootDir:r,data:n}=this;for(const[n,s]of e.entries()){const e=n+1;let o=t[e];o?s!==o.name&&await o.rename(s):(o=r.requestFolder(s),t[e]=o)}n.groups=e}async isEpisodeUptodate(e,t,r){if(!e.files||!e.files.length)return!1;if(t.updateId&&e.updateId!==t.updateId)return!1;if(t.groupId&&e.groupId!==t.groupId)return!1;const n=this.folders[e.groupId||0];if(!n)throw new Error(`Folder must not be ${n}`);if(!r.checkFs)return!0;try{for(const t of e.files){const e=n.requestFile(t);await e.access(),await e.close()}return!0}catch(e){return!1}}async pingEpisode(e,t,r){const{data:{episodes:n}}=this;let s=n[e];return s||(s={},n[e]=s),!await this.isEpisodeUptodate(s,t,r)&&s}async updateEpisode(e,t,r){const s=await this.pingEpisode(e,t,r);if(!s)return;if(s.files){const e=this.folders[s.groupId||0];await Promise.all(s.files.map(t=>e.requestFile(t).remove())),delete s.files}await t.fetch(),s.groupId=t.groupId,s.updateId=t.updateId;const o=this.folders[s.groupId||0];if(!o)throw new Error(`Folder must not be ${o}`);const i=new c(`${(e+1).toString().padStart(this.pad0,"0")} `);t.content&&(t.content(i),delete t.content);const a=[];for(const[e,t]of i.files){let r;r=t instanceof Buffer?t:n.flow(t.join("\n\n---\n\n")).then(e=>"\n"!==e[e.length-1]?e+"\n":e).then(Buffer.from).value,a.push(e);const s=o.requestFile(e);await s.write(r),await s.close()}a.length&&(s.files=a)}preprocess(e){let t,r=0;const n=[];let s=1;for(const o of e){const e=o;++s,(e.group!==t||s>50)&&(s=1,r=n.length+1,n.push(`${r.toString().padStart(this.pad0,"0")} ${e.group||""}`.trim()),t=e.group),e.groupId=r}return{groups:n,chapters:e}}async load(){const{metaFile:e}=this;try{const t=await this.decode(await e.read()),{data:r}=this;await this.updateGroups(t.groups),r.episodes=t.episodes||[]}catch(e){if("ENOENT"!==e.code)throw e}}async save(){const{metaFile:e}=this;await e.write(await this.encode(this.data))}}},function(e,t){e.exports=require("zlib")},function(e,t){e.exports=require("lodash/throttle")}]);
//# sourceMappingURL=cli.js.map