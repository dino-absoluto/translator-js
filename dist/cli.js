!function(e){var t={};function r(s){if(t[s])return t[s].exports;var n=t[s]={i:s,l:!1,exports:{}};return e[s].call(n.exports,n,n.exports,r),n.l=!0,n.exports}r.m=e,r.c=t,r.d=function(e,t,s){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(r.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)r.d(s,n,function(t){return e[t]}.bind(null,n));return s},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=7)}([function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.trim=(e=>{if(e&&(e=e.trim()).length)return e}),t.flow=(e=>({then:r=>e?t.flow(r(e)):t.flow(void 0),value:e}))},function(e,t){e.exports=require("path")},function(e,t){e.exports=require("chalk")},function(e,t){e.exports=require("jsdom")},function(e,t){e.exports=require("p-limit")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s=r(0),n=r(3),i=r(1),o=r(24),a=s.flow(new n.JSDOM).then(e=>e.window.Node).value,l=e=>e.nodeType===a.ELEMENT_NODE;class h{constructor(){this.names=new Set,this.urls=new Map}resolveName(e){if("."===(e=i.normalize(s.trim(e)||"")))return;const t=i.extname(e),r=o(i.basename(e,t));e=r+t;const{names:n}=this;if(!n.has(e))return n.add(e),e;for(let e=1;e<100;e++){const s=`${r} (${e})${t}`;if(!n.has(s))return n.add(s),s}return""}mapURL(e,t){this.urls.set(e,t)}resolveURL(e){return this.urls.get(e)||e}parseNode(e){return this.render(h.tokenize(e))}render(e){let t="";for(const r of e){let e;switch(r.type){case"text":e=r.text;break;case"ruby":e=`${r.text}(${r.ruby})`;break;case"link":e=`[${r.text}](${this.resolveURL(r.url)})`;break;case"image":e=`![${r.text}](${this.resolveURL(r.url)})`;break;case"br":e="\n";break;default:e=""}t+=e}return t}static tokenizeArray(e){return[...e].reduce((e,t)=>e.concat(h.tokenize(t)),[])}static tokenize(e){if(e.nodeType===a.TEXT_NODE)return[{type:"text",text:(e.textContent||"").replace(/^\n|\n$/g,"")}];if(!l(e))return[];switch(e.nodeName){case"RUBY":{const t=s.trim(s.flow(e.querySelector("rb")).then(e=>e.textContent).value||s.flow([...e.children]).then(e=>{let t="";for(const r of e)r.nodeType===a.TEXT_NODE&&(t+=r.textContent);return t}).value||e.textContent);if(t){const r=s.flow(e.querySelector("rt")).then(e=>s.trim(e.textContent)).value;return r&&t!==r?[{type:"ruby",text:t,ruby:r}]:[{type:"text",text:t}]}return[]}case"BR":return s.flow(e.nextSibling).then(e=>e.nodeType===a.TEXT_NODE&&e.textContent||void 0).then(e=>e.startsWith("\n"))?[]:[{type:"br"}];case"A":{const t=e,r={type:"link",text:t.textContent||t.href,url:t.href},s=[...t.querySelectorAll("img")].reduce((e,t)=>e.concat(this.tokenize(t)),[]);return s.length?(s.push({type:"br"}),s.push(r),s):[r]}case"IMG":{const t=e;return[{type:"image",text:t.alt,url:t.src}]}case"IFRAME":case"VIDEO":case"EMBEDED":return[];case"P":{const t=h.tokenizeArray(e.childNodes);return t.push({type:"br"}),t}default:return h.tokenizeArray(e.childNodes)}}}t.Context=h;t.SimpleContext=class extends h{constructor(){super(...arguments),this.text=[],this.bufs=[]}requestFile(e,t){const r=this.resolveName(e);if(!r)return;let s=t(r);Array.isArray(s)?this.text.push([r,s]):this.bufs.push([r,s])}}},function(e,t){e.exports=require("fs")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s=r(8),n=r(10),i=r(2),o=r(32);try{s.parser.command(n).help().fail((e,t)=>{s.parser.showHelp(),t?console.log(i.default.red(t.stack||"")):console.error(i.default.red(e))}).command("test",!1,e=>e,async e=>{const t=new o.Progress.Progress,r=new o.Progress.Group({flexShrink:0}),s=new o.Progress.Bar({width:20,postProcess:(...e)=>i.default.green(e[0])+i.default.yellow(e[1])+i.default.gray(e[2])});r.add(new o.Progress.Text({text:"⸨",flexShrink:0})),r.add(s),r.add(new o.Progress.Text({text:"⸩",flexShrink:0})),r.add(new o.Progress.Space),r.add(new o.Progress.Text({text:"Hello! Welcome to Hell!",align:o.Progress.TextAlignment.Left,postProcess:i.default.green})),t.add(r);const n=new o.Progress.Spinner({postProcess:i.default.blue});r.add(n),t.add(n),t.add(new o.Progress.Spinner({postProcess:i.default.yellow})),t.add(new o.Progress.Spinner({postProcess:i.default.yellow})),t.add(new o.Progress.Space({width:5}));const a=new o.Progress.Text({text:"Hello World!",flex:1,postProcess:i.default.gray});t.add(a),t.add(new o.Progress.Space);const l=new o.Progress.Bar({width:20,flex:1,ratio:.1,postProcess:(...e)=>i.default.gray(e[2])+i.default.yellow(e[1])+i.default.green(e[0])});t.add(new o.Progress.Text({text:"⸨",flexShrink:0}),0),t.add(l,1),t.add(new o.Progress.Text({text:"⸩",flexShrink:0}),2),t.update();let h=0,c=0;const d=setInterval(()=>{c++,a.text=`Hello World! ${c}`,s.ratio+=.03,l.ratio+=.015,s.ratio>=1&&(s.ratio=0),l.ratio>=1&&(a.parent&&t.delete(a),t.clearLine(),console.log("Looped"),l.ratio=0,h++>3&&(clearInterval(d),t.clear(),console.log(1e3*t.count/t.elapsed)))},40)}).parse()}catch(e){console.error(i.default.red((e.stack||"").toString()))}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s=r(9);t.parser=s.strict(!0).usage("$0 <cmd> [args]").demandCommand(1).group(["help","version"],"Info:").option("pedantic",{default:!0,hidden:!0,type:"boolean",desc:"Exit on first error"})},function(e,t){e.exports=require("yargs")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s=r(1),n=r(2),i=r(11),o=r(12),a=r(13),l=s.resolve(".");t.handler=(async e=>{if(!e.sources)throw new Error("no sources specified");const t=!!e.checkFs,l=e.outputDir||s.resolve("download"),{Series:h}=await Promise.resolve().then(()=>r(14)),c=e.name||[],d=e.sources.map(t=>"url"===t.type?{overwrite:e.overwrite,outputDir:l,sourceURL:t.url.toString(),basename:c.shift()}:{overwrite:e.overwrite,outputDir:s.dirname(t.fpath),basename:s.basename(t.fpath)}),u=new i.Output;process.on("SIGINT",()=>{u.clear(!1),process.exit(0)});try{u.append(new i.HideCursor,1,new i.Spinner({postProcess:n.default.cyan}));for(const e of d){const r=new h(e),l=new i.Group,c=new i.Bar({width:20,postProcess:a((...e)=>e.join(""),n.default.green,n.default.yellow,n.default.gray)}),d=new i.Text({text:"",postProcess:n.default.yellow,flex:{shrink:1,grow:0}}),f=o(()=>{l.append("⸨",c,"⸩",1,d,new i.Text({text:s.basename(r.container.name||"unknown"),flex:{shrink:1,grow:0}})),u.add(l,0)});await r.ready;const p=await r.updateIndex({onProgress:(e,t,r)=>{r>0&&(f(),d.text=t+"/"+r+" ",c.ratio=t/r)},checkFs:t});l.clear(),u.remove(l),u.clearLine(),console.log(n.default`⸨{yellow ${p.updates.length.toString()} updated}, {green ${p.news.length.toString()} new}⸩ ${s.basename(r.container.name||"unknown")}`);const m=p.news.length;for(const{index:e,chapter:t}of p.news.slice(0,20))console.log(n.default`{green ${e.toString().padStart(3,"0")}} ${t.name}`);p.news.length>20&&console.log(n.default`{gray ...}and {green ${m.toString()}} more chapters`)}}finally{u.clear()}}),t.command="get [<sources>..]",t.describe="Download novel from sources",t.builder=(e=>e.strict().usage("$0 get [--output-dir=<path>] [options] [<URL> | <path>..]").coerce("sources",e=>(Array.isArray(e)||(e=[e]),e.map(e=>{try{return{type:"url",url:new URL(e)}}catch(t){return{type:"folder",fpath:s.relative(l,s.resolve(e))}}}))).option("output-dir",{type:"string",default:"download",requiresArg:!0,coerce:e=>{if(Array.isArray(e))throw new Error("--output-dir was used twice");return s.normalize(e)},desc:"Output directory"}).option("name",{type:"string",requiresArg:!0,coerce:e=>Array.isArray(e)?e:[e],desc:"Hint to name new folder"}).option("overwrite",{type:"boolean",default:!1,desc:"Force overwriting exist data"}).option("check-fs",{type:"boolean",default:!1,desc:"Download missing files"}))},function(e,t){e.exports=require("@dinoabsoluto/flex-progress")},function(e,t){e.exports=require("lodash/once")},function(e,t){e.exports=require("lodash/overArgs")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=r(15);t.Series=s.Series,t.SeriesOptions=s.SeriesOptions},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=r(16);t.Series=s.Series,t.SeriesOptions=s.SeriesOptions},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s=r(17),n=r(25),i=r(29),o=r(1);t.Series=class{constructor(e){const t=Object.assign({},e.novel,e.data);let r;this.data=t,this.novel=e.novel,this.overwrite=!!e.overwrite;const s=e.basename||this.data.name;t.name=s;const i=(r=e.basename?new n.Folder(null,o.join(e.outputDir,e.basename)):new n.Folder(null,e.outputDir).requestFolder(s||"")).requestFile("index.json");this.container=r,this.metaFile=i,this.ready=(async()=>{!this.novel&&e.sourceURL&&await this.loadURL(e.sourceURL),s&&await this.load()})()}async loadURL(e){try{const t=new URL(e);this.novel=await s.getNovel(t)}catch(e){throw new Error("failed to get novel")}}async verify(e){if(e&&"object"==typeof e){if(e.sourceURL){if(!this.overwrite)throw new Error("unsupported older version, use overwrite to refresh");if(!this.novel)try{const t=new URL(e.sourceURL);this.novel=await s.getNovel(t)}catch(e){throw new Error("failed to get novel")}}return e.id?e:void 0}}async load(){const{metaFile:e,data:t,data:{name:r}}=this;if(r)try{const r=await e.read(),s=JSON.parse(r.toString());Object.assign(t,await this.verify(s)),!this.novel&&t.url&&await this.loadURL(t.url)}catch(e){if("ENOENT"!==e.code)throw e}}hasMeta(){const{data:e}=this;return!!(e.name&&e.author&&e.description&&e.genre&&e.keywords&&e.status)}async update(){const{novel:e,data:t}=this;if(!e)throw new Error("novel is undefined");this.hasMeta()||await e.fetch(),Object.assign(t,e);const r=t.name;r&&this.container.renameable&&await this.container.rename(r),await this.metaFile.write(JSON.stringify(t,null,1))}async updateIndex(e={}){const{onProgress:t,checkFs:r=!1}=e;let s;t&&(s=t.bind(void 0,this)),await this.update(),this.episodes||(this.episodes=new i.EpisodeList(this.container));const{novel:n,episodes:o}=this;if(!n)throw new Error("novel is undefined");await o.ready;const a=await n.fetchIndex();return o.updateWith(a,{progress:s,checkFs:r})}}},function(e,t,r){"use strict";let s;Object.defineProperty(t,"__esModule",{value:!0});const n=new Map;t.register=(e=>{for(const t of e.acceptDomains){if(n.has(t))throw new Error(`'${t}' domain existed`);n.set(t,e)}}),t.getProvider=(async e=>{if(!s)return s=(async()=>{t.register((await Promise.resolve().then(()=>r(18))).default)})(),await s,t.getProvider(e);let i=n.get(e.host);if(!i)throw new Error("no matching provider");return i}),t.getNovel=(async e=>{let r=(await t.getProvider(e)).fromURL(e);if(!r)throw new Error("failed to create Novel instance");return r})},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s=r(0),n=r(19),i=r(5);class o{constructor(e){this.url=e.url,this.group=e.group,this.name=e.name,this.updateId=e.updateId}async fetch(){const e=this.url.toString(),t=(await n.fetchDOM(e)).getElementById("novel_contents");if(!t)return;s.flow(t.querySelector(".novel_subtitle")).then(e=>s.trim(e.textContent)).then(e=>{this.name=e});const r=[];["#novel_p","#novel_honbun","#novel_a"].forEach(e=>s.flow(t.querySelector(e)).then(e=>{r.push(e)}));const o=r.map(i.Context.tokenize),a=[];for(const e of o)for(const t of e)"image"===t.type&&a.push(n.fetchFile(t.url));const l=await Promise.all(a);this.content=(e=>{for(const t of l)e.requestFile(t.name,r=>(e.mapURL(t.url,r),t.buf));e.requestFile(this.name+".txt",t=>{const r=o.map(t=>e.render(t));return r.unshift(this.name),r})})}}t.SyosetuChapter=o;class a{constructor(e){const t=e.hostname;if(0===t.indexOf("novel18."))this.over18=!0;else{if(0!==t.indexOf("ncode."))throw new Error("wrong domain");this.over18=!1}const r=e.pathname.split("/",2);if(r.length<2)throw new Error("invalid pathname");this.id=r[1],this.url=this.indexURL}get rootURL(){return`https://${this.over18?"novel18":"ncode"}.syosetu.com/`}get infoURL(){return`${this.rootURL}novelview/infotop/ncode/${this.id}/`}get indexURL(){return`${this.rootURL}${this.id}/`}async fetch(){const e=this.infoURL,t=await n.fetchDOM(e),r=t.getElementById("contents_main");if(!r)throw console.log(t.body.innerHTML),new Error("failed to find contents");{const e=r.getElementsByTagName("h1")[0];if(!e)throw new Error("failed to parse header");this.name=e.textContent||void 0}{const e=r.querySelectorAll("#noveltable1 > tbody > tr > td");if(4!==e.length)throw new Error("failed to parse table");this.description=s.trim(e[0].textContent),this.author=s.trim(e[1].textContent),this.keywords=s.flow(s.trim(e[2].textContent)).then(e=>e.split(/\s+/g)).value,this.genre=s.flow(s.trim(e[3].textContent)).then(e=>e.split("〔",1)[0]).value}{let e=!0,t=0,s=r.querySelector("#noveltype_notend");if(s?e=!1:s=r.querySelector("#noveltype"),!s||!s.textContent)throw new Error("failed to detect novel type");if("短編"===s.textContent.trim())t=1;else{let e=s.nextSibling;if(!e||!e.textContent)throw new Error("failed to detect novel size");let r=e.textContent.match(/(?<=全)\d+(?=部分)/);r&&r[0]&&(t=parseInt(r[0],10))}this.status={completed:e,size:t}}}async fetchIndex(){const e=this.indexURL;let t=(await n.fetchDOM(e)).getElementsByClassName("index_box")[0];if(!t)throw new Error("failed to get index_box");const r=[];let i;for(const e of t.children)if(e.classList.contains("chapter_title"))i=s.trim(e.textContent);else if(e.classList.contains("novel_sublist2")){if(e.children.length<2)continue;let t,n,a;{const r=e.children[0].firstElementChild;if(r&&"A"===r.tagName){let e=r;t=s.trim(r.textContent),n=new URL(e.href)}}{const t=e.children[1],r=t.firstElementChild;a=r?s.trim(r.getAttribute("title")):s.trim(t.textContent)}if(t&&n){let e=new o({url:n,group:i,name:t,updateId:a});r.push(e)}}return r}}t.SyosetuNovel=a;const l={acceptDomains:["ncode.syosetu.com","novel18.syosetu.com"],fromURL:e=>{try{return new a(e)}catch(e){return}}};t.default=l},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s=r(0),n=r(3),i=r(20),o=r(21);t.fetchDOM=(async e=>{let{window:{document:t}}=new n.JSDOM(await(await o.default(e)).text(),{url:e});return t}),t.fetchFile=(async e=>{const t=await o.default(e),r=await t.buffer();{const n=t.headers.get("content-disposition");if(n){const t=s.trim(s.flow(n.match(/; filename="[^"]+"/)).then(e=>e[1]).value);if(t)return{url:e,buf:r,name:t}}}{const n=t.headers.get("content-type");if(n){const t=s.flow(s.trim(n.split(";")[0])).then(i.getExtension).value;if(t)return{url:e,buf:r,name:`untitled.${t}`}}}return{url:e,buf:r,name:"untitled"}})},function(e,t){e.exports=require("mime")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s=r(22),n=r(23),i=r(4).default(1);t.default=function(e,t){let r="string"==typeof e?new URL(e.toString()):new URL(e.url);if(r.host.endsWith("syosetu.com")){t||(t={});const o=new n.Headers(t.headers);return t.headers=o,/^(novel18|noc|mnlt|mid)./.test(r.hostname)&&o.set("Cookie",s.serialize("over18","yes")),i(()=>n.default(e,t))}return n.default(e,t)}},function(e,t){e.exports=require("cookie")},function(e,t){e.exports=require("node-fetch")},function(e,t){e.exports=require("filenamify")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s=r(0),n=r(26),i=r(1),o=r(28),a=e=>s.flow(s.trim(e)).then(i.normalize).then(e=>{if(i.basename(e)===e&&!e.startsWith(".."))return e}).value;class l{constructor(e,t){this.children=new Set,this._accessed=!1,e?(this.parent=e,this._dirname=a(t)):this._dirname=i.resolve(t)}get name(){return this._dirname}get path(){const{parent:e,_dirname:t}=this;if(!t)throw new Error("Folder's path is undefined");return e?i.join(e.path,t):t}async real(){this._accessed||(await o(this.path),this._accessed=!0)}async close(){delete this._dirname,this.parent&&this.parent.children.delete(this)}async remove(){const{children:e}=this;if(!e.size)throw new Error("folder is not empty");const t=this.path;await this.close(),await n.rmdir(t)}get renameable(){return!!this.parent}async rename(e){if(!this.parent)throw new Error("folder cannot be renamed");const t=a(e);if(!t)throw new Error("folder name is invalid");const r=this._dirname;if(this._dirname=t,this._accessed=!1,r){if(t===r)return;try{const e=this.parent.path;await n.rename(i.join(e,r),i.join(e,t))}catch(e){if("ENOENT"!==e.code)throw e}}}requestFolder(e){const t=new l(this,e);return this.children.add(t),t}requestFile(e){const t=new h(this,e);return this.children.add(t),t}}t.Folder=l;class h{constructor(e,t){this.parent=e,this._filename=a(t)}get path(){const{parent:e,_filename:t}=this;if(!t)throw new Error("filename is not set");return i.join(e.path,t)}async real(){if(!this._filename)throw new Error("filename is not set")}async rename(e){const t=a(e);if(!t)throw new Error("filename is invalid");const r=this._filename;if(this._filename=t,r){if(t===r)return;try{const e=this.parent.path;await n.rename(i.join(e,r),i.join(e,t))}catch(e){if("ENOENT"!==e.code)throw e}}}async close(){delete this._filename,this.parent.children.delete(this)}async access(e){return n.access(this.path,e)}async remove(){await this.real();const e=this.path;await this.close();try{await n.unlink(e)}catch(e){if("ENOENT"!==e.code)throw e}}async read(){return await this.real(),n.readFile(this.path)}async write(e){await this.parent.real(),await this.real(),await n.writeFile(this.path,e)}}t.File=h},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s=r(6),n=r(27);var i=r(6);t.constants=i.constants,t.readFile=n.promisify(s.readFile),t.writeFile=n.promisify(s.writeFile),t.rename=n.promisify(s.rename),t.unlink=n.promisify(s.unlink),t.rmdir=n.promisify(s.rmdir),t.access=n.promisify(s.access)},function(e,t){e.exports=require("util")},function(e,t){e.exports=require("make-dir")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s=r(0),n=r(5),i=r(30),o=r(4),a=r(31);class l extends n.Context{constructor(e){super(),this.files=new Map,this.prefix=e}requestFile(e,t){const{files:r,prefix:n}=this;s.flow(this.resolveName(`${n}${e}`.trim())).then(e=>{r.has(e)||r.set(e,t(e))})}}t.EpisodeList=class{constructor(e,t={}){this.pad0=3,this.saveThrottle=a(this.save.bind(this),3e3),this.rootDir=e,this.data=t.data||{groups:[],episodes:[]},this.compressedCache=!!t.compressedCache,this.pad0=t.pad0||this.pad0;const r=e.requestFolder("!meta").requestFile(this.compressedCache?"!cache.json.gz":"!cache.json"),s=[e.requestFolder("0".padStart(this.pad0,"0"))];this.folders=s,this.metaFile=r,this.ready=this.load()}async updateWith(e,t={}){const{data:{episodes:r}}=this,{groups:s,chapters:n}=this.preprocess(e),{progress:i}=t,a={updates:[],news:[]},l=o.default(2),h=r.length;await this.updateGroups(s);const c=[];for(const[e,r]of n.entries())if(await this.pingEpisode(e,r,t)){const t={index:e,chapter:r};c.push(t),e<h?a.updates.push(t):a.news.push(t)}let d=0;const u=c.length;return i&&i(0,u),await Promise.all(c.map(({index:e,chapter:r})=>l(async()=>{await this.updateEpisode(e,r,t),await this.saveThrottle(),i&&i(++d,u)}))),r.length=n.length,await this.saveThrottle.flush(),a}encode(e){return this.compressedCache?i.gzipSync(JSON.stringify(e)):JSON.stringify(e,null,1)}decode(e){return this.compressedCache?JSON.parse(i.gunzipSync(e).toString()):JSON.parse(e.toString())}async updateGroups(e){const{folders:t,rootDir:r,data:s}=this;for(const[s,n]of e.entries()){const e=s+1;let i=t[e];i?n!==i.name&&await i.rename(n):(i=r.requestFolder(n),t[e]=i)}s.groups=e}async isEpisodeUptodate(e,t,r){if(!e.files||!e.files.length)return!1;if(t.updateId&&e.updateId!==t.updateId)return!1;if(t.groupId&&e.groupId!==t.groupId)return!1;const s=this.folders[e.groupId||0];if(!s)throw new Error(`Folder must not be ${s}`);if(!r.checkFs)return!0;try{for(const t of e.files){const e=s.requestFile(t);await e.access(),await e.close()}return!0}catch(e){return!1}}async pingEpisode(e,t,r){const{data:{episodes:s}}=this;let n=s[e];return n||(n={},s[e]=n),!await this.isEpisodeUptodate(n,t,r)&&n}async updateEpisode(e,t,r){const n=await this.pingEpisode(e,t,r);if(!n)return;if(n.files){const e=this.folders[n.groupId||0];await Promise.all(n.files.map(t=>e.requestFile(t).remove())),delete n.files}await t.fetch(),n.groupId=t.groupId,n.updateId=t.updateId;const i=this.folders[n.groupId||0];if(!i)throw new Error(`Folder must not be ${i}`);const o=new l(`${(e+1).toString().padStart(this.pad0,"0")} `);t.content&&(t.content(o),delete t.content);const a=[];for(const[e,t]of o.files){let r;r=t instanceof Buffer?t:s.flow(t.join("\n\n---\n\n")).then(e=>"\n"!==e[e.length-1]?e+"\n":e).then(Buffer.from).value,a.push(e);const n=i.requestFile(e);await n.write(r),await n.close()}a.length&&(n.files=a)}preprocess(e){let t,r=0;const s=[];let n=1;for(const i of e){const e=i;++n,(e.group!==t||n>50)&&(n=1,r=s.length+1,s.push(`${r.toString().padStart(this.pad0,"0")} ${e.group||""}`.trim()),t=e.group),e.groupId=r}return{groups:s,chapters:e}}async load(){const{metaFile:e}=this;try{const t=await this.decode(await e.read()),{data:r}=this;await this.updateGroups(t.groups),r.episodes=t.episodes||[]}catch(e){if("ENOENT"!==e.code)throw e}}async save(){const{metaFile:e}=this;await e.write(await this.encode(this.data))}}},function(e,t){e.exports=require("zlib")},function(e,t){e.exports=require("lodash/throttle")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s=r(33),n=r(34),i=r(35),o=r(36),a=(()=>{try{return r(37)}catch(e){return e=>e.length}})();!function(e){class t{constructor(e){this._minWidth=0,this._maxWidth=Number.MAX_SAFE_INTEGER,this._flexGrow=0,this._flexShrink=0,this.willUpdate=!1,e&&(this.width=e.width,this.minWidth=e.minWidth||0,this.maxWidth=e.maxWidth||Number.MAX_SAFE_INTEGER,this.postProcess=e.postProcess,e.flex&&(this.flex=e.flex),e.flexGrow&&(this.flexGrow=e.flexGrow),e.flexShrink&&(this.flexShrink=e.flexShrink))}get minWidth(){return this._minWidth}get maxWidth(){return this._maxWidth}set minWidth(e){this._minWidth=Math.max(e||0,0)}set maxWidth(e){this._maxWidth=Math.min(e||Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER)}isFlexible(){return!(this.width||this.minWidth===this.maxWidth)}get flexGrow(){return this.isFlexible()?this._flexGrow:0}set flexGrow(e){this._flexGrow=Math.max(0,e||0)}get flexShrink(){return this.isFlexible()?this._flexShrink:0}set flexShrink(e){this._flexShrink=Math.max(0,e||0)}set flex(e){this.flexGrow=e,this.flexShrink=e}get parent(){return this._parent}set parent(e){const{_parent:t}=this;t&&this.willUnmount(t),this._parent=e,e&&this.mounted(e)}wrap(...e){return this.postProcess?this.postProcess(...e):e.join("")}update(){if(!this.willUpdate)return this.willUpdate=!0,setImmediate(()=>this.onUpdate()),!1}onUpdate(){this.willUpdate=!1;const{parent:e}=this;e&&e.update()}mounted(e){}willUnmount(e){}}e.Item=t;let r;e.Spinner=class extends t{constructor(e){super(e),this.width=1,this._style={width:1,frames:["⠋","⠙","⠹","⠸","⠼","⠴","⠦","⠧","⠇","⠏"]},this._frame=0,this.onFrame=(()=>{this._frame=(this._frame+1)%this.style.frames.length,this.update()}),e&&e.style&&(this.style=e.style)}get style(){return this._style}set style(e){e.width||(e.width=a(e.frames[0])),this._frame=0,this._style=e}calculateWidth(){return this._style.width}mounted(e){e.addFrameEvent(this.onFrame)}willUnmount(e){e.removeFrameEvent(this.onFrame)}render(e){if(0===e)return"";let{_frame:t,style:{frames:r}}=this;return this.wrap(r[t%r.length])}},function(e){e.Left="left",e.Center="center",e.Right="right"}(r=e.TextAlignment||(e.TextAlignment={}));e.Text=class extends t{constructor(e){super(i(e,{flexShrink:1})),this._text="",this.align=r.Center,e&&(this.text=e.text||this.text,this.align=e.align||this.align)}get text(){return this._text}set text(e){this._text=e,this.update()}get length(){return a(this.text)}calculateWidth(){return n(this.length,this.minWidth,this.maxWidth)}grow(e){let{text:t}=this;const s=e-this.length;let n=0;this.align===r.Center?n=Math.floor(s/2):this.align===r.Right&&(n=s);const i=s-n;return" ".repeat(n)+t+" ".repeat(i)}shrink(e){return e<=0?"":this.text.substr(0,e-1)+"…"}render(e){if(0===e)return"";let{text:t}=this;const r=!(!e||!this.flexGrow),s=!!this.flexShrink;e=Math.min(null!=e?e:Number.MAX_SAFE_INTEGER,this.maxWidth);const n=this.length;if(r&&n<e)return this.wrap(this.grow(e));if(s&&n>e)return this.wrap(this.shrink(e));const{minWidth:i}=this;return n<i?this.wrap(this.grow(i)):this.wrap(t)}};e.Space=class extends t{calculateWidth(){return n(this.width||1,this.minWidth,this.maxWidth)}render(e){if(0===e)return"";const t=!(!e||!this.flexGrow),r=!!this.flexShrink;e=Math.min(null!=e?e:Number.MAX_SAFE_INTEGER,this.maxWidth);const s=this.calculateWidth();return" ".repeat(t&&s<e||r&&s>e?e:s)}};class l extends t{constructor(e){super(i(e,{minWidth:5})),this.symbols=["░","▒","▓","█"],this._ratio=0,e&&(this.symbols=e.symbols||this.symbols,this._ratio=e.ratio||this._ratio)}get ratio(){return this._ratio}set ratio(e){this._ratio=n(e,0,1),this.update()}static renderBar(e,t,r){const s=e.length-1,n=Math.floor(r*s*t),i=n%s,o=Math.floor((n-i)/s),a=r-(i?1:0)-o;return[e[e.length-1].repeat(o),i&&e[i]||"",e[0].repeat(a)]}calculateWidth(){return n(this.width||0,this.minWidth,this.maxWidth)}render(e){if(0===e)return"";let{ratio:t}=this;const r=!(!e||!this.flexGrow),s=!!this.flexShrink;e=Math.min(e||Number.MAX_SAFE_INTEGER,this.maxWidth);let n=this.calculateWidth();return r&&n<e?n=e:s&&n>e&&(n=e),this.wrap(...l.renderBar(this.symbols,t,n))}}e.Bar=l;class h extends t{constructor(){super(...arguments),this.children=[],this.flexGrowSum=0,this.flexShrinkSum=0,this.growableChildren=[],this.shrinkableChildren=[],this.frameEvents=new Set,this.onFrame=(()=>{for(const e of this.frameEvents)e()})}get flexGrow(){return this.flexGrowSum&&this.growableChildren.length}get flexShrink(){return this.flexShrinkSum&&this.shrinkableChildren.length/this.children.length}addFrameEvent(e){const{frameEvents:t}=this;t.add(e),t.size>0&&(this.interval||(this.interval=setInterval(this.onFrame,80)))}removeFrameEvent(e){this.frameEvents.delete(e),0===this.frameEvents.size&&(this.interval&&clearInterval(this.interval),this.interval=void 0)}add(e,t){const{children:r}=this;if(null!=t&&Number.isInteger(t)&&Math.abs(t)<r.length){const s=t>=0?t:t+r.length;r.splice(t,0,e),e.parent=this;for(let e=s;e<r.length;++e)r[e].id=e}else{const t=r.length;r.push(e),e.parent=this,e.id=t}(e.flexGrow||e.flexShrink)&&this.updateFlex()}delete(e){if(e.parent!==this||null==e.id)return;const t=e.id,{children:r}=this;r.splice(e.id,1),e.parent=void 0,e.id=void 0;for(let e=t;e<r.length;++e)r[e].id=e;(e.flexGrow||e.flexShrink)&&this.updateFlex()}addItem(...e){const{children:t}=this;for(const r of e){const e=t.length;t.push(r),r.parent=this,r.id=e}this.updateFlex()}removeItem(...e){const{children:t}=this;for(const r of e){const e=t.indexOf(r);e>=0&&(t.splice(e,1),r.parent=void 0,r.id=void 0)}this.updateFlex()}clearItems(){const{children:e}=this;for(const t of e)t.parent=void 0;e.length=0}updateFlex(){const{children:e,growableChildren:t,shrinkableChildren:r}=this;let s=0,n=0;t.length=0,r.length=0;for(const i of e)i.flexGrow&&(s+=i.flexGrow,t.push(i)),i.flexShrink&&(n+=i.flexShrink,r.push(i));o(t,["flexGrow","id"],["desc","asc"]),o(r,["flexShrink","id"],["desc","asc"]),this.flexGrowSum=s,this.flexShrinkSum=n}growRound(e,t,r){const{growableChildren:s}=this;let i=t/this.flexGrow;for(const o of s){const s=n(r(o.flexGrow*i),0,t);if(t-=s,e[o.id]+=s,0===t)break}return t}grow(e,t,r){let s=r-t;(s=this.growRound(e,s,Math.floor))>0&&(s=this.growRound(e,s,Math.round))}shrinkRound(e,t,r){const{shrinkableChildren:s}=this;let i=0;const o=s.map(t=>{const r=t.id,s=e[r]*t.flexShrink;return i+=s,s}),a=t/i;for(const[i,l]of s.entries()){const s=o[i],h=n(r(s*a),0,t),c=l.id;if(t-=h,e[c]-=h,0===t)break}return t}shrink(e,t,r){let s=t-r;(s=this.shrinkRound(e,s,Math.floor))>0&&(s=this.shrinkRound(e,s,Math.ceil))}render(e){if(0===e)return"";const{children:t}=this,r=!(!e||!this.flexGrow),s=!!this.flexShrink;e=Math.min(e||Number.MAX_SAFE_INTEGER,this.maxWidth);const n=[];let i=0;for(const e of t){const t=e.calculateWidth();n.push(t),i+=t}r&&i<e?this.grow(n,i,e):s&&i>e&&this.shrink(n,i,e);let o=this.children.map((e,t)=>e.render(n[t])).join("");return this.wrap(o)}calculateWidth(){const{children:e}=this;let t=0;for(const r of e){t+=r.calculateWidth()}return t}}e.Group=h;e.Progress=class extends h{constructor(e){if(super(e),this.stream=process.stderr,this.isTTY=!0,this.lastColumns=0,this.count=0,this.createdTime=Date.now(),e){const{stream:t}=e;t&&(this.stream=t,this.isTTY=!!t.isTTY)}}get elapsed(){return Date.now()-this.createdTime}clearLine(){const{stream:e}=this;s.clearLine(e,0),s.cursorTo(e,0),s.clearScreenDown(e)}clear(){super.clearItems(),this.clearLine()}get columns(){return this.stream.columns||40}onUpdate(){super.onUpdate();const{stream:e,columns:t,lastColumns:r}=this,n=this.render(t);r!==t&&(this.lastColumns=t,this.clearLine()),e.write(n),s.cursorTo(e,0),this.count++}}}(t.Progress||(t.Progress={}))},function(e,t){e.exports=require("readline")},function(e,t){e.exports=require("lodash/clamp")},function(e,t){e.exports=require("lodash/defaults")},function(e,t){e.exports=require("lodash/orderBy")},function(e,t){e.exports=require("string-width")}]);
//# sourceMappingURL=cli.js.map