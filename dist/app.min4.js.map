{"version":3,"file":"app.min4.js","sources":["../src/get/engine-kakuyomu.mjs"],"sourcesContent":["/**\n * @file Get module\n * @author Dino <dinoabsoluto+dev@gmail.com>\n * @license\n * This file is part of translator-js.\n *\n * translator-js is free software: you can redistribute it and/or modify\n * it under the terms of the GNU General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * translator-js is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU General Public License for more details.\n *\n * You should have received a copy of the GNU General Public License\n * along with translator-js.  If not, see <http://www.gnu.org/licenses/>.\n *\n */\n/* imports */\nimport * as base from './base'\nimport { JSDOM } from 'jsdom'\nimport got from 'got'\nimport hash from './utils/hash'\nimport getExternal from './utils/get-external'\n/* -imports */\n\nexport class Chapter extends base.Chapter {\n  async update () {\n    const { props } = this\n    const oldFiles = props.files\n    delete props.files\n    /* prioritize props.doc */\n    if (props.buffer && !props.doc) {\n      props.files = [\n        {\n          fname: this.getName(`${props.title}.txt`),\n          integity: undefined,\n          buffer: props.buffer\n        }\n      ]\n      return\n    }\n    let doc = props.doc\n    if (!doc) {\n      if (!props.sourceURL) {\n        return\n      }\n      doc = await (async () => {\n        let { window: { document: doc } } =\n        new JSDOM((await got(props.sourceURL)).body, { url: props.sourceURL })\n        return doc\n      })()\n    }\n    let files = []\n    let imgs = []\n    let rootNode = doc.getElementById('contentMain-inner')\n    for (const img of rootNode.getElementsByTagName('img')) {\n      let node = doc.createTextNode(`![](${img.src})`)\n      img.parentNode.replaceChild(node, img)\n      imgs.push(img.src)\n    }\n    props.files = files\n    {\n      const buffer = await props.buffer\n      let text = buffer ? (\n        typeof buffer === 'function' ? await buffer() : buffer.toString()\n      ) : ''\n      const selectors = [\n        'widget-episodeTitle',\n        'widget-episode'\n      ]\n      for (const sel of selectors) {\n        for (const node of rootNode.getElementsByClassName(sel)) {\n          text += node.textContent + '\\n\\n-----\\n\\n'\n        }\n      }\n      files.push({\n        fname: this.getName(`${props.title}.txt`),\n        integity: undefined,\n        buffer: text\n      })\n    }\n    await getExternal({\n      prefix: this.prefix,\n      oldFiles,\n      files,\n      urls: imgs\n    })\n  }\n}\n\nexport class Volume extends base.Volume {\n}\n\nexport class Series extends base.Series {\n  static test (url) {\n    return /^((http|https):\\/\\/|)kakuyomu.jp\\/works\\/[^/]+\\/?$/.test(url)\n  }\n\n  get Chapter () { return Chapter }\n  get Volume () { return Volume }\n\n  async fetch () {\n    const url = this.sourceURL\n    let { window: { document: doc } } = new JSDOM((await got(url)).body, { url: url })\n    let volumes = []\n    let chapters = []\n    let description = ''\n    {\n      let text = ''\n      text += doc.getElementById('workTitle').textContent + '\\n'\n      text += `Author: ${\n        doc.getElementById('workAuthor-activityName').textContent}\\n`\n      text += `\\n${\n        doc.getElementById('introduction').textContent}\\n`\n      description += text\n      text = undefined\n      chapters.push({\n        title: 'Description',\n        integrity: Date.now(),\n        buffer: () => description\n      })\n    }\n    let volumeIndex = -1\n    for (const toc of doc.getElementsByClassName('widget-toc-items')) {\n      for (const ep of toc.children) {\n        if (ep.classList.contains('widget-toc-chapter')) {\n          let title = ep.textContent.trim()\n          volumes.push({\n            title\n          })\n          description += `\\n## ${title}\\n`\n          ++volumeIndex\n        } else {\n          let a = ep.getElementsByClassName('widget-toc-episode-episodeTitle')[0]\n          let sourceURL = a.href\n          let title = a.getElementsByClassName('widget-toc-episode-titleLabel')[0].textContent\n          let integrity = a.getElementsByClassName('widget-toc-episode-datePublished')[0]\n            .getAttribute('datetime')\n          description += `${\n            String(chapters.length).padStart(3, '0')\n          } ${title}\\n`\n          chapters.push({\n            volume: volumeIndex,\n            sourceURL,\n            title,\n            integrity\n          })\n        }\n      }\n    }\n    chapters[0].integrity = hash(description)\n    return this.patch({\n      volumes,\n      chapters\n    })\n  }\n}\n\nexport default Series\n"],"names":["Chapter","base","props","this","oldFiles","files","buffer","doc","fname","getName","title","integity","undefined","sourceURL","window","document","JSDOM","got","body","url","imgs","rootNode","getElementById","img","getElementsByTagName","node","createTextNode","src","parentNode","replaceChild","push","text","toString","selectors","sel","getElementsByClassName","textContent","getExternal","prefix","urls","Volume","Series","test","volumes","chapters","description","integrity","Date","now","volumeIndex","toc","ep","children","classList","contains","trim","a","href","getAttribute","String","length","padStart","volume","hash","patch"],"mappings":"8cA4BO,MAAMA,gBAAgBC,uCAEnBC,MAAEA,GAAUC,KACZC,EAAWF,EAAMG,gBAChBH,EAAMG,MAETH,EAAMI,SAAWJ,EAAMK,gBACzBL,EAAMG,MAAQ,CACZ,CACEG,MAAOL,KAAKM,WAAWP,EAAMQ,aAC7BC,cAAUC,EACVN,OAAQJ,EAAMI,cAKhBC,EAAML,EAAMK,QACXA,EAAK,KACHL,EAAMW,iBAGXN,OAAY,eACJO,QAAUC,SAAUR,IAC1B,IAAIS,mBAAaC,IAAIf,EAAMW,YAAYK,KAAM,CAAEC,IAAKjB,EAAMW,mBACnDN,GAHG,OAMVF,EAAQ,GACRe,EAAO,GACPC,EAAWd,EAAIe,eAAe,yBAC7B,MAAMC,KAAOF,EAASG,qBAAqB,OAAQ,KAClDC,EAAOlB,EAAImB,sBAAsBH,EAAII,QACzCJ,EAAIK,WAAWC,aAAaJ,EAAMF,GAClCH,EAAKU,KAAKP,EAAII,KAEhBzB,EAAMG,MAAQA,SAENC,QAAeJ,EAAMI,WACvByB,EAAOzB,EACS,mBAAXA,QAA8BA,IAAWA,EAAO0B,WACrD,SACEC,EAAY,CAChB,sBACA,sBAEG,MAAMC,KAAOD,MACX,MAAMR,KAAQJ,EAASc,uBAAuBD,GACjDH,GAAQN,EAAKW,YAAc,gBAG/B/B,EAAMyB,KAAK,CACTtB,MAAOL,KAAKM,WAAWP,EAAMQ,aAC7BC,cAAUC,EACVN,OAAQyB,UAGNM,sBAAY,CAChBC,OAAQnC,KAAKmC,OACblC,SAAAA,EACAC,MAAAA,EACAkC,KAAMnB,KAKL,MAAMoB,eAAevC,kBAGrB,MAAMwC,eAAexC,6BACbkB,SACJ,sDAAqDuB,KAAKvB,wBAG3CnB,4BACDwC,2BAGfrB,EAAMhB,KAAKU,cACXC,QAAUC,SAAUR,IAAU,IAAIS,mBAAaC,IAAIE,IAAMD,KAAM,CAAEC,IAAKA,IACxEwB,EAAU,GACVC,EAAW,GACXC,EAAc,QAEZd,EAAO,GACXA,GAAQxB,EAAIe,eAAe,aAAac,YAAc,KACtDL,cACExB,EAAIe,eAAe,2BAA2Bc,gBAChDL,QACExB,EAAIe,eAAe,gBAAgBc,gBACrCS,GAAed,EACfA,OAAOnB,EACPgC,EAASd,KAAK,CACZpB,MAAO,cACPoC,UAAWC,KAAKC,MAChB1C,OAAQ,IAAMuC,QAGdI,GAAe,MACd,MAAMC,KAAO3C,EAAI4B,uBAAuB,wBACtC,MAAMgB,KAAMD,EAAIE,YACfD,EAAGE,UAAUC,SAAS,sBAAuB,KAC3C5C,EAAQyC,EAAGf,YAAYmB,OAC3BZ,EAAQb,KAAK,CACXpB,MAAAA,IAEFmC,WAAuBnC,QACrBuC,MACG,KACDO,EAAIL,EAAGhB,uBAAuB,mCAAmC,GACjEtB,EAAY2C,EAAEC,KACd/C,EAAQ8C,EAAErB,uBAAuB,iCAAiC,GAAGC,YACrEU,EAAYU,EAAErB,uBAAuB,oCAAoC,GAC1EuB,aAAa,YAChBb,MACEc,OAAOf,EAASgB,QAAQC,SAAS,EAAG,QAClCnD,MACJkC,EAASd,KAAK,CACZgC,OAAQb,EACRpC,UAAAA,EACAH,MAAAA,EACAoC,UAAAA,WAKRF,EAAS,GAAGE,UAAYiB,eAAKlB,GACtB1C,KAAK6D,MAAM,CAChBrB,QAAAA,EACAC,SAAAA"}