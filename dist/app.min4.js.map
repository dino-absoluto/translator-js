{"version":3,"file":"app.min4.js","sources":["../src/get/engine-kakuyomu.mjs"],"sourcesContent":["/**\n * @file Get module\n * @author Dino <dinoabsoluto+dev@gmail.com>\n * @license\n * This file is part of translator-js.\n *\n * translator-js is free software: you can redistribute it and/or modify\n * it under the terms of the GNU General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * translator-js is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU General Public License for more details.\n *\n * You should have received a copy of the GNU General Public License\n * along with translator-js.  If not, see <http://www.gnu.org/licenses/>.\n *\n */\n/* imports */\nimport * as base from './base'\nimport { JSDOM } from 'jsdom'\nimport got from 'got'\nimport hash from './utils/hash'\nimport toFiles from './utils/to-files'\n/* -imports */\n\nexport class Chapter extends base.Chapter {\n  async updateFiles () {\n    const { props } = this\n    const options = Object.assign({}, props, {\n      prefix: this.prefix,\n      got\n    })\n    return toFiles(options, async (doc, utils) => {\n      let files = []\n      let imgs = utils.getImages('#contentMain-inner img')\n      let rootNode = doc.getElementById('contentMain-inner')\n      {\n        const buffer = await props.buffer\n        let text = buffer ? (\n          typeof buffer === 'function' ? await buffer() : buffer.toString()\n        ) : ''\n        const selectors = [\n          'widget-episodeTitle',\n          'widget-episode'\n        ]\n        for (const sel of selectors) {\n          for (const node of rootNode.getElementsByClassName(sel)) {\n            text += node.textContent + '\\n\\n-----\\n\\n'\n          }\n        }\n        files.push({\n          fname: this.getName(`${props.title}.txt`),\n          integity: undefined,\n          buffer: text\n        })\n      }\n      return [ files, imgs ]\n    })\n  }\n}\n\nexport class Volume extends base.Volume {\n}\n\nexport class Series extends base.Series {\n  static test (url) {\n    return /^((http|https):\\/\\/|)kakuyomu.jp\\/works\\/[^/]+\\/?$/.test(url)\n  }\n\n  get Chapter () { return Chapter }\n  get Volume () { return Volume }\n\n  async fetch () {\n    const url = this.sourceURL\n    let { window: { document: doc } } = new JSDOM((await got(url)).body, { url: url })\n    let volumes = []\n    let chapters = []\n    let description = ''\n    {\n      let text = ''\n      text += doc.getElementById('workTitle').textContent + '\\n'\n      text += `Author: ${\n        doc.getElementById('workAuthor-activityName').textContent}\\n`\n      text += `\\n${\n        doc.getElementById('introduction').textContent}\\n`\n      description += text\n      text = undefined\n      chapters.push({\n        title: 'Description',\n        integrity: Date.now(),\n        buffer: () => description\n      })\n    }\n    let volumeIndex = -1\n    for (const toc of doc.getElementsByClassName('widget-toc-items')) {\n      for (const ep of toc.children) {\n        if (ep.classList.contains('widget-toc-chapter')) {\n          let title = ep.textContent.trim()\n          volumes.push({\n            title\n          })\n          description += `\\n## ${title}\\n`\n          ++volumeIndex\n        } else {\n          let a = ep.getElementsByClassName('widget-toc-episode-episodeTitle')[0]\n          let sourceURL = a.href\n          let title = a.getElementsByClassName('widget-toc-episode-titleLabel')[0].textContent\n          let integrity = a.getElementsByClassName('widget-toc-episode-datePublished')[0]\n            .getAttribute('datetime')\n          description += `${\n            String(chapters.length).padStart(3, '0')\n          } ${title}\\n`\n          chapters.push({\n            volume: volumeIndex,\n            sourceURL,\n            title,\n            integrity\n          })\n        }\n      }\n    }\n    chapters[0].integrity = hash(description)\n    return this.patch({\n      volumes,\n      chapters\n    })\n  }\n}\n\nexport default Series\n"],"names":["Chapter","base","props","this","options","Object","assign","prefix","got","toFiles","async","doc","utils","files","imgs","getImages","rootNode","getElementById","buffer","text","toString","selectors","sel","node","getElementsByClassName","textContent","push","fname","getName","title","integity","undefined","Volume","Series","url","test","sourceURL","window","document","JSDOM","body","volumes","chapters","description","integrity","Date","now","volumeIndex","toc","ep","children","classList","contains","trim","a","href","getAttribute","String","length","padStart","volume","hash","patch"],"mappings":"0eA4BO,MAAMA,gBAAgBC,4CAEnBC,MAAEA,GAAUC,KACZC,EAAUC,OAAOC,OAAO,GAAIJ,EAAO,CACvCK,OAAQJ,KAAKI,WACbC,iBAEKC,kBAAQL,EAASM,MAAOC,EAAKC,SAC9BC,EAAQ,GACRC,EAAOF,EAAMG,UAAU,0BACvBC,EAAWL,EAAIM,eAAe,4BAE1BC,QAAehB,EAAMgB,WACvBC,EAAOD,EACS,mBAAXA,QAA8BA,IAAWA,EAAOE,WACrD,SACEC,EAAY,CAChB,sBACA,sBAEG,MAAMC,KAAOD,MACX,MAAME,KAAQP,EAASQ,uBAAuBF,GACjDH,GAAQI,EAAKE,YAAc,gBAG/BZ,EAAMa,KAAK,CACTC,MAAOxB,KAAKyB,WAAW1B,EAAM2B,aAC7BC,cAAUC,EACVb,OAAQC,UAGL,CAAEN,EAAOC,MAKf,MAAMkB,eAAe/B,kBAGrB,MAAMgC,eAAehC,6BACbiC,SACJ,sDAAqDC,KAAKD,wBAG3ClC,4BACDgC,2BAGfE,EAAM/B,KAAKiC,cACXC,QAAUC,SAAU3B,IAAU,IAAI4B,mBAAa/B,QAAI0B,IAAMM,KAAM,CAAEN,IAAKA,IACxEO,EAAU,GACVC,EAAW,GACXC,EAAc,QAEZxB,EAAO,GACXA,GAAQR,EAAIM,eAAe,aAAaQ,YAAc,KACtDN,cACER,EAAIM,eAAe,2BAA2BQ,gBAChDN,QACER,EAAIM,eAAe,gBAAgBQ,gBACrCkB,GAAexB,EACfA,OAAOY,EACPW,EAAShB,KAAK,CACZG,MAAO,cACPe,UAAWC,KAAKC,MAChB5B,OAAQ,IAAMyB,QAGdI,GAAe,MACd,MAAMC,KAAOrC,EAAIa,uBAAuB,wBACtC,MAAMyB,KAAMD,EAAIE,YACfD,EAAGE,UAAUC,SAAS,sBAAuB,KAC3CvB,EAAQoB,EAAGxB,YAAY4B,OAC3BZ,EAAQf,KAAK,CACXG,MAAAA,IAEFc,WAAuBd,QACrBkB,MACG,KACDO,EAAIL,EAAGzB,uBAAuB,mCAAmC,GACjEY,EAAYkB,EAAEC,KACd1B,EAAQyB,EAAE9B,uBAAuB,iCAAiC,GAAGC,YACrEmB,EAAYU,EAAE9B,uBAAuB,oCAAoC,GAC1EgC,aAAa,YAChBb,MACEc,OAAOf,EAASgB,QAAQC,SAAS,EAAG,QAClC9B,MACJa,EAAShB,KAAK,CACZkC,OAAQb,EACRX,UAAAA,EACAP,MAAAA,EACAe,UAAAA,WAKRF,EAAS,GAAGE,UAAYiB,eAAKlB,GACtBxC,KAAK2D,MAAM,CAChBrB,QAAAA,EACAC,SAAAA"}